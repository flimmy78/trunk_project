#!/bin/bash

if [[ -n "${__ETC_APPKEY_APPKEY_IN__}" ]]; then
	return
else
	__ETC_APPKEY_APPKEY_IN__="$0"
fi

. ${__ROOTFS__}/etc/utils/utils.in

#
#$1:app
#
appkey_file() {
	local app="$1"

	echo "/etc/appkey/${app}.key"
}

#
#$1:app
#$2:key
#$3:value
#
appkey_set() {
	local app="$1"
	local key="$2"; shift 2
	local value="$*"

	local file=$(appkey_file ${app})
	setmultifilevalue "${file}" "${key}" "${value}"
}

#
#$1:app
#$2:key
#
appkey_get() {
	local app="$1"
	local key="$2"

	local file=$(appkey_file ${app})
	echo $(getmultifilevalue "${file}" "${key}")
}

#
#$1:app
#$2:key
#
get_uci_value() {
	local app="$1"
	local key="$2"

	echo $(uci get ${app}.${key})
}

#
#$1:app
#
appkey_load_uci() {
	local app="$1"
	local file=$(appkey_file ${app})
	local key value

	for key in $(awk '{print $1}' ${file} | sed '/#/d;/^$/d'); do
		value=$(get_uci_value ${app} ${key})
		appkey_set "${app}" "${key}" "${value}"
	done
}
